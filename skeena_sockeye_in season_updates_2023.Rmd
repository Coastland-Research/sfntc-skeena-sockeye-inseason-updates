---
title: |
  | Skeena Sockeye In Season Update
  | for SFNTC
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    
    fig_caption: yes
  html_notebook: default
geometry: "left=3cm,right=3cm,top=2cm,bottom=2cm"
editor_options:
  chunk_output_type: console
header-includes:
  - \usepackage{placeins}
  - \usepackage[justification=raggedright,labelfont=bf,singlelinecheck=false]{caption}
knit: (function(input, ...) {
      rmarkdown::render(
      input,
      output_file = paste0(
        xfun::sans_ext(input), '-', Sys.Date(), '.pdf'
         ),
      envir = globalenv()
        )}
        )
---

---

```{r setup options,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE,echo=FALSE) 

```

```{r load libraries, include=FALSE}
library(tidyverse)
library(data.table)
library(readxl)
library(knitr)
library(ggpubr)

options(scipen=10000)
```

```{r loda data and format, include=FALSE}
data<-read_excel("data/tyee and catch and fence in-season updates 2023.xlsx",sheet="Tyee")
data$Date<-as.Date(data$Date)
```

```{r set days, echo=FALSE}
tyee.day<-as.Date("2023-07-03")
tyee.date<-"July 3"
fence.day<-as.Date("2023-07-03")
fence.date<-"July 3"
```

# Summary

- Still early on, cumulative total escapement of 113,302 past Tyee to date (compares to 135,874 to July 3 last year) (Table 1, Figure 1).

- Very early to determine run-timing, indications may be average run-timing so far, although this may change through the season (Figure 2).

- Catchability coefficient in 2023 is 1307 sockeye per index point.

- Although very early, the simple Tyee run-timing model suggests a run between ~ 1-4M, with the average run-timing final run forecast at ~ 1.9M (Figure 3).

- Marine sockeye FSC ongoing, with sockeye FSC in-river beginning.

- Early indications indicate large, healthy fish.

- No commercial catch to date.

- 

\newpage

# Tyee Escapement and TRTC

```{r tyee table,echo=FALSE,results='asis'}
i<-match(tyee.day,data$Date)

average<-data$average[i]

e<-data$cumtyee[i]
t<-data$cumtrtc[i]
c<-data$cumcatch[i]

avgper<-round(data$Runtiming[i],3)*100
earlyper<-round(data$Runtiming[i+7],3)*100
lateper<-round(data$Runtiming[i-7],3)*100

#stat2<-data.frame(`Cumulative to Date`=c("Escapement Past Tyee","TRTC (Escapement+Catch)","Catch (preliminary"),`Number of Sockeye`=c(e,t,c))
#kable(stat2,caption=paste0("Cumulative escapement, TRTC, and catch to ",todate,"."))

stat3<-data.frame(`Cumulative to Date`=c("Escapement Past Tyee","TRTC (Escapement+Catch)","Catch (preliminary)"),`Number of Sockeye`=c(e,t,c),
                  `Run Timing`=c("Average","One week early","One week late"),`Percent Through`=c(avgper,earlyper,lateper))

kable(stat3,caption=paste0("Cumulative escapement, TRTC, and catch to ",tyee.date,"."))

```

```{r tyee plot setup, echo=FALSE,warning=FALSE}
escandtrtcdaily<-data%>%select(Date,Escapement=esctyee,TRTC=dailytrtc,`Average Escapement 85-21`=`ave85-21`)%>%
  pivot_longer(2:4,values_to="Number of Sockeye",names_to="Type")%>%
  mutate(lt=case_when(Type=="Escapement"|Type=="TRTC"~"2022",
                      Type=="Average Escapement 85-21"~"Average"))

t1<-ggplot(escandtrtcdaily,aes(x=Date,y=`Number of Sockeye`,color=Type,linetype=lt))+
  geom_line(size=1.1)+
  scale_color_manual(values=c("black","deepskyblue1","deepskyblue4"))+
  theme_classic()+
  grids(linetype = "dashed")+
  theme(legend.title = element_blank(),legend.position = "top")+
  guides(linetype="none")

escandtrtccum<-data%>%select(Date,Escapement=cumtyee,TRTC=cumtrtc,`Average Escapement 85-21`=`cum85-21`)%>%
  pivot_longer(2:4,values_to="Number of Sockeye",names_to="Type")%>%
  mutate(lt=case_when(Type=="Escapement"|Type=="TRTC"~"2022",
                      Type=="Average Escapement 85-21"~"Average"))

t2<-ggplot(escandtrtccum,aes(x=Date,y=`Number of Sockeye`,color=Type,linetype=lt))+
  geom_line(size=1.1)+
  scale_color_manual(values=c("black","deepskyblue1","deepskyblue4"))+
  theme_classic()+
  grids(linetype = "dashed")+
  theme(legend.title = element_blank(),legend.position = "top")+
  guides(linetype="none")
```

```{r tyee plots,fig.height=6,echo=FALSE,warning=FALSE,fig.cap="Daily (top) and cumulative (bottom) estimated escapement and TRTC (escapement + adjusted catch) at the Tyee test fishery versus the 1985-2021 average."}

ggarrange(t1,t2,align="v",ncol=1)

```

```{r,include=TRUE,fig.height=6,echo=FALSE,warning=FALSE,fig.cap="Cumulative estimated daily proportion of TRTC based on 1985-2021 average."}
i<-match(tyee.day,data$Date)

early<-data$early[i]
average<-data$average[i]
late<-data$late[i]

pcum<-data%>%select(Date,cumtrtc,`Cumulative Proportion (85-21)`=`pcum85-21`)%>%
  mutate(`1.5M`=cumtrtc/1500000,
         `2M`=cumtrtc/2000000,
         `2.5M`=cumtrtc/2500000,
         `3M`=cumtrtc/3000000,
         `3.5M`=cumtrtc/3500000)%>%
  select(-cumtrtc)%>%
  pivot_longer(2:7,names_to="Type",values_to="Cumulative Proportion")%>%
  mutate(Type=factor(Type,levels=c("Cumulative Proportion (85-21)","1.5M","2M","2.5M","3M","3.5M")))

cols<-RColorBrewer::brewer.pal(5, "Set1")

g1<-ggplot(pcum,aes(x=Date,y=`Cumulative Proportion`,color=Type,linetype=Type))+
  geom_line(size=1)+
  scale_colour_manual(values=c("grey50", cols))+
  scale_linetype_manual(values=c("dashed","solid","solid","solid","solid","solid"))+
  theme_classic()+
  grids(linetype = "dashed")+
  theme(legend.title=element_blank(),legend.position=c(.8,.2),legend.background = element_blank())

g2<-ggplot(pcum,aes(x=Date,y=`Cumulative Proportion`,color=Type,linetype=Type))+
  geom_line(size=1)+
  scale_colour_manual(values=c("grey50", cols))+
  scale_linetype_manual(values=c("dashed","solid","solid","solid","solid","solid"))+
  theme_classic()+
  grids(linetype = "dashed")+
  theme(legend.title=element_blank(),legend.position=c(.2,.8),legend.background = element_blank())+
  ylim(0,.25)+
  xlim(as.Date("2023-06-10"),as.Date("2023-07-15"))

ggarrange(g1,g2,align="v",ncol=1)

```

\newpage

# Tyee run-timing model

```{r tyee model table,echo=FALSE,results='asis'}

i<-match(tyee.day,data$Date)

early<-round(data$early[i],0)
average<-round(data$average[i],0)
late<-round(data$late[i],0)

stat1<-data.frame(`Run-Timing`=c("Early","Average","Late"),`Forecasted Final Run Size`=c(early,average,late))

kable(stat1,caption="Forecasted sockeye final TRTC based on early, average and late run-timing.")

```

```{r tyee model figure,fig.height=4,echo=FALSE,warning=FALSE,fig.cap="Forecasted final TRTC of Skeena sockeye based on the simple scalar run-timing model."}
tyeemodel<-data%>%select(Date,Early=early,Average=average,Late=late)%>%
  pivot_longer(2:4,values_to="Number of Sockeye",names_to="Timing")

ggplot(tyeemodel,aes(x=Date,y=`Number of Sockeye`,color=Timing))+
  geom_line(size=1.5)+
  scale_color_brewer(palette="Set1")+
  theme_classic()+
  grids(linetype = "dashed")+
  theme(legend.position = "top")
```
